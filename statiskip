#!/bin/bash

# ----------------------------
# Statisk IP deploy script
# ----------------------------

# Server:Hostname NåværendeIP NyIP
servers=(
  "Tromso-server:10.0.0.25:10.0.0.14"
  "Web-server:10.0.0.26:10.0.0.15"
  "Backup-server:10.0.0.22:10.0.0.16"
  "Harstad-server:10.0.0.17:10.0.0.17"
  "Bodo-server:10.0.0.24:10.0.0.18"
)

USER="askild"
GATEWAY="10.0.0.1"
DNS1="8.8.8.8"
DNS2="8.8.4.4"

for entry in "${servers[@]}"; do
  IFS=":" read -r hostname oldip newip <<< "$entry"

  echo "==============================="
  echo "Oppdaterer $hostname (fra $oldip til $newip)..."

  # Lag netplan YAML midlertidig
  cat > netplan-temp.yaml <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - $newip/24
      gateway4: $GATEWAY
      nameservers:
        addresses:
          - $DNS1
          - $DNS2
EOF

  # Kopier fil til server
  echo "Sender netplan-fil til $hostname ($oldip)..."
  scp netplan-temp.yaml $USER@$oldip:/tmp/netplan.yaml

  # Kjør remote: backup + apply
  echo "Bruker sudo på $hostname for å oppdatere netplan..."
  ssh $USER@$oldip <<EOF
sudo cp /etc/netplan/01-netcfg.yaml /etc/netplan/01-netcfg.yaml.bak
sudo mv /tmp/netplan.yaml /etc/netplan/01-netcfg.yaml
sudo netplan apply
echo "$(date '+%Y-%m-%d %H:%M:%S') - Netplan applied for $hostname ($newip)" >> ~/ip-change.log
EOF

  echo "→ Fullført for $hostname. Ny IP: $newip"
done

# Fjern midlertidig fil
rm netplan-temp.yaml
echo "==============================="
echo "Alle serverne er oppdatert!"
